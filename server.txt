サーバーのメモ


centosのバージョンとbento/centosのバージョンについて
https://teratail.com/questions/62830

yum update していけば Cent OS 7.x 系の最新バージョン
（現在は 7.3 ）になるので、どれから始めても似たようなものです。

vagrant box add bento/centos-7.3  --provider virtualbox



### コマンド  ####

vimでの変更を上書き保存できない場合
:w !sudo tee %を使用

⚠︎ #はサーバー内でのコマンド $はローカルのコマンド
作業フォルダ => os_server/centos7.5


バージョン確認
# cat /etc/redhat-release
CentOS Linux release 7.5.1804 (Core)


$ vagrant up # vagrantが立ち上がる
$ vagrant status # vagrantのステータスを確認 runningとなって入れば起動されている

$ vagrant ssh   # サーバーにsshで入る

# exit
$ vagrant half # vagrant停止


VPSにアクセス
$ ssh root@118.27.9.161
パスワード N***************

# 鍵設定
公開鍵をvpsに渡して、Mac側の秘密鍵と照らし合わせマッチさせることでセキュリティ向上
vps側の ~/.sshに作成
転送コマンド
$ scp ~/.ssh/meloon.pub nattu@118.27.9.161:~/.ssh/authorized_keys

鍵認証ができるようになった
$ ssh -i ~/.ssh/meloon nattu@118.27.9.161


 # sshの設定  (/etc/ssh/sshd_configをいじる)

1.ポート番号の変更 22-> 6183
2.パスワードログインの禁止 # スピード維持のため、してない
3.root禁止              # スピード維持のため、してない

サーバーリスタートして、設定の読み込み
# systemctl restart sshd
↑CentOS 7 からは serviceではなく、systemctl コマンドを使うらしい。
さらにCentOS7ではiptablesではなく、firewalldを使用するとのこと。
$ service iptables stop ->systemctl stop firewalld

ファイアウォール起動   systemctl start firewalld
再起動 systemctl restart firewalld
終了   systemctl stop firewalld

# firewallの設定 -> ⚠️centos6はiptablesだったが、7からはfirewalldになるので要注意
https://www.server-memo.net/centos-settings/firewalld/firewalld.html

/etc/sysconfig/iptablesに書いてある

許容する通信などが記載されてあるので、今後firewall関連でエラーが出た際には、
こちらにacceptの胸を記述する必要あり

⚠️ 6183を許可していないため、現状firewallをスタートさせるとサーバーからアクセスを
拒絶されてしまうので、注意する-> 設定ファイルに記載する必要あり
firewalldの設定マニュアル
⭐️http://www.kakiro-web.com/linux/firewalld.html

mysql
https://enomotodev.hatenablog.com/entry/2016/09/01/225200

パスワードの確認 $ sudo cat /var/log/mysqld.log | grep password
2018-09-12T07:40:17.199490Z 1 [Note] A temporary password is generated for root@localhost: v&N+midJd5tS(←ここの部分)

mysqlにログイン
$ mysql -u root -p(secret.txtに記載)
$ show databases;


mysqlに接続できない問題

fender natsukisugawara$ bundle exec rake db:create
"Can't connect to local MySQL server through socket '/tmp/mysql.sock' (2)
Couldn't create database for {"adapter"=>"mysql2", "encoding"=>"utf8", "pool"=>5, "host"=>"localhost", "database"=>"fender_development", "username"=>"root"}
rake aborted!
Mysql2::Error::ConnectionError: Can't connect to local MySQL server through socket '/tmp/mysql.sock' (2)
/Users/natsukisugawara/.rbenv/versions/2.5.1/bin/bundle:23:in `load'
/Users/natsukisugawara/.rbenv/versions/2.5.1/bin/bundle:23:in `<main>'
Tasks: TOP => db:create
(See full trace by running task with --trace)"

↓以下のようにして解決
$ whoami
natsukisugawara
oasis:fender natsukisugawara$ sudo chown -R natsukisugawara:wheel /usr/local/var/mysql



## Nginxの設定

コマンド
自動起動設定
$ sudo systemctl enable nginx
起動
$ sudo systemctl start nginx
停止
$ sudo systemctl stop nginx
設定適用
$ sudo systemctl reload nginx
稼働状況確認
$ sudo systemctl status nginx


/etc/nginx/conf.d/local.confに設定ファイルがある

/var/log/nginx/error.log # エラーログのパス
/var/log/nginx/access.log # アクセス



⚠️後回し

$ rake assets:precompile RAILS_ENV=production  # => 環境変数をサーバーに付与する必要
rake aborted!
ArgumentError: Missing required arguments: aws_access_key_id, aws_secret_access_key
/Users/natsukisugawara/Desktop/fender/config/initializers/carrier_wave.rb:5:in `block in <main>'
/Users/natsukisugawara/Desktop/fender/config/initializers/carrier_wave.rb:4:in `<main>'
/Users/natsukisugawara/Desktop/fender/config/environment.rb:5:in `<main>'
Tasks: TOP => environment
(See full trace by running task with --trace)






バグってるなう

ローカルに

Host fender
  HostName 118.28.9.161
  User hoge
  Port 6183
  IdentityFile  ~/.ssh/fender/id_rsa

  のようなファイルを作成し
  ssh fenderで通信できればOK => できた

リモートからgithubにアクセスできなかった件
  .ssh以下のid_rsa id_rsa.pubの所有者がrootになっていたので、nattuの操作ではpermission エラーになっていた
  -> 所有者を変えることで解決
  $sudo chown nattu:nattu id_rsa.pub

  $ ssh -vT git@github.com # デバッグに便利



cap production deployでのエラー
1. bundle installができない

参考記事)https://blog.wackwack.net/entry/2014/06/24/005051
https://www.pistolfly.com/weblog/2012/01/change-path-environment-with-r.html
~> ** DEPLOY FAILED
** Refer to log/capistrano.log for details. Here are the last 20 lines:


  INFO [89645011] Finished in 0.123 seconds with exit status 0 (successful).

 DEBUG [b9a75c7f] Running [ -L /var/www/app/fender/releases/20180916155036/public/assets ] as user@***.**.*.***

 DEBUG [b9a75c7f] Command: [ -L /var/www/app/fender/releases/20180916155036/public/assets ]

 DEBUG [4835d854] Finished in 0.124 seconds with exit status 1 (failed).

 DEBUG [5094f5a4] Running [ -d /var/www/app/fender/releases/20180916155036/public/assets ] as user@***.**.*.***

 DEBUG [5094f5a4] Command: [ -d /var/www/app/fender/releases/20180916155036/public/assets ]

 DEBUG [863a2bb4] Finished in 0.122 seconds with exit status 1 (failed).

  INFO [de2725c3] Running /usr/bin/env ln -s /var/www/app/fender/shared/public/assets /var/www/app/fender/releases/20180916155036/public/assets as user@***.**.*.***

 DEBUG [de2725c3] Command: ( export RBENV_ROOT="/home/user/.rbenv" RBENV_VERSION="2.5.1" ; /usr/bin/env ln -s /var/www/app/fender/shared/public/assets /var/www/app/fender/releases/20180916155036/public/assets )

  INFO [a90efcc3] Finished in 0.128 seconds with exit status 0 (successful).

 DEBUG [04d3f607] Running if test ! -d /var/www/app/fender/releases/20180916155036; then echo "Directory does not exist '/var/www/app/fender/releases/20180916155036'" 1>&2; false; fi as user@***.**.*.***

 DEBUG [04d3f607] Command: if test ! -d /var/www/app/fender/releases/20180916155036; then echo "Directory does not exist '/var/www/app/fender/releases/20180916155036'" 1>&2; false; fi

 DEBUG [f82397df] Finished in 0.119 seconds with exit status 0 (successful).

 DEBUG [2efa1e88] Running /home/user/.rbenv/bin/rbenv exec bundle check --path /var/www/app/fender/shared/bundle as user@***.**.*.***

 DEBUG [2efa1e88] Command: cd /var/www/app/fender/releases/20180916155036 && ( export RBENV_ROOT="/home/user/.rbenv" RBENV_VERSION="2.5.1" ; /home/user/.rbenv/bin/rbenv exec bundle check --path /var/www/app/fender/shared/bundle )

 DEBUG [f78703ad] 	/usr/bin/env: ruby: そのようなファイルやディレクトリはありません

 DEBUG [f78703ad] Finished in 0.194 seconds with exit status 127 (failed).

  INFO [06a59c4a] Running /home/user/.rbenv/bin/rbenv exec bundle install --path /var/www/app/fender/shared/bundle --without development test --deployment --quiet as user@***.**.*.***

 DEBUG [06a59c4a] Command: cd /var/www/app/fender/releases/20180916155036 && ( export RBENV_ROOT="/home/user/.rbenv" RBENV_VERSION="2.5.1" ; /home/user/.rbenv/bin/rbenv exec bundle install --path /var/www/app/fender/shared/bundle --without development test --deployment --quiet )

 DEBUG [d6342b8b] 	/usr/bin/env: ruby: そのようなファイルやディレクトリはありません

 => default_envを設定して修復した。

2. fogのバージョン依存のエラー
bundler:install
     01 /home/nattu/.rbenv/bin/rbenv exec bundle install --path /var/www/app/fender/shared/bundle --without development test --deployment --quiet
     01 Gem::Ext::BuildError: ERROR: Failed to build gem native extension.
     01
     01 current directory:
     01 /var/www/app/fender/shared/bundle/ruby/2.5.0/gems/unf_ext-0.0.7.5/ext/unf_ext
     01 /home/nattu/.rbenv/versions/2.5.1/bin/ruby -r ./siteconf20180920-5079-18g39y3.rb
     01 extconf.rb
     01 checking for -lstdc++... no
     01 creating Makefile
     01
     01 current directory:
     01 /var/www/app/fender/shared/bundle/ruby/2.5.0/gems/unf_ext-0.0.7.5/ext/unf_ext
     01 make "DESTDIR=" clean
     01
     01 current directory:
     01 /var/www/app/fender/shared/bundle/ruby/2.5.0/gems/unf_ext-0.0.7.5/ext/unf_ext
     01 make "DESTDIR="
     01 compiling unf.cc
     01 make: g++: コマンドが見つかりませんでした
     01 make: *** [unf.o] エラー 127
     01
     01 make failed, exit code 2
     01
     01 Gem files will remain installed in
     01 /var/www/app/fender/shared/bundle/ruby/2.5.0/gems/unf_ext-0.0.7.5 for
     01 inspection.
     01 Results logged to
     01 /var/www/app/fender/shared/bundle/ruby/2.5.0/extensions/x86_64-linux/2.5.0-static/unf_ext-0.0.7.5/gem_make.out
     01
     01 An error occurred while installing unf_ext (0.0.7.5), and Bundler cannot
     01 continue.
     01 Make sure that `gem install unf_ext -v '0.0.7.5' --source
     01 'https://rubygems.org/'` succeeds before bundling.
     01
     01 In Gemfile:
     01   fog was resolved to 2.0.0, which depends on
     01     fog-ovirt was resolved to 1.1.2, which depends on
     01       rbovirt was resolved to 0.1.7, which depends on
     01         rest-client was resolved to 2.0.2, which depends on
     01           http-cookie was resolved to 1.0.3, which depends on
     01             domain_name was resolved to 0.5.20180417, which depends on
     01               unf was resolved to 0.1.4, which depends on
     01                 unf_ext
https://qiita.com/nariatsu/items/7c260df42289b7acc711

3. assets precompileのエラー

Tasks: TOP => deploy:assets:precompile
(See full trace by running task with --trace)
The deploy has failed with an error: Exception while executing as nattu@118.27.9.161: rake exit status: 1
rake stdout: rake aborted!
ArgumentError: Missing required arguments: aws_access_key_id, aws_secret_access_key
/var/www/app/fender/shared/bundle/ruby/2.5.0/gems/fog-core-1.45.0/lib/fog/core/service.rb:244:in `validate_options'



再起動したあととかだと、cap productionができなくなる
$ ssh-add ~/.ssh/fender/meloon



unicornエラー
unicorn:start
      01 /home/nattu/.rbenv/bin/rbenv exec bundle exec unicorn -c /var/www/app/fender/current/config/unicorn/production.rb -E deployment -D
      01 bundler: failed to load command: unicorn (/var/www/app/fender/shared/bundle/ruby/2.5.0/bin/unicorn)
      01 ArgumentError: directory for pid=/var/www/app/fender/current/shared/tmp/pids/unicorn.pid not writable
      01   /var/www/app/fender/shared/bundle/ruby/2.5.0/gems/unicorn-5.4.1/lib/unicorn/configurator.rb:100:in `block in reload'


      # unicorn:start
      #       01 /home/nattu/.rbenv/bin/rbenv exec bundle exec unicorn -c /var/www/app/fender/current/config/unicorn/production.rb -E deployment -D
      #       01 -----------------------------------------------------------------
      #       01 -------------メッシメッシメッシメッシメッシメッシメッシ-----------------
      #       01 -----------------------------------------------------------------
      #       01 bundler: failed to load command: unicorn (/var/www/app/fender/shared/bundle/ruby/2.5.0/bin/unicorn)
      #       01 ArgumentError: directory for pid=/var/www/app/fender/current/shared/tmp/pids/unicorn.pid not writable
      #       01   /var/www/app/fender/shared/bundle/ruby/2.5.0/gems/unicorn-5.4.1/lib/unicorn/configurator.rb:100:in `block in reload'
      #       01   /var/www/app/fender/shared/bundle/ruby/2.5.0/gems/unicorn-5.4.1/lib/unicorn/configurator.rb:96:in `each'
      #       01   /var/www/app/fender/shared/bundle/ruby/2.5.0/gems/unicorn-5.4.1/lib/unicorn/configurator.rb:96:in `reload'
      #       01   /var/www/app/fender/shared/bundle/ruby/2.5.0/gems/unicorn-5.4.1/lib/unicorn/configurator.rb:77:in `initialize'
      #       01   /var/www/app/fender/shared/bundle/ruby/2.5.0/gems/unicorn-5.4.1/lib/unicorn/http_server.rb:77:in `new'
      #       01   /var/www/app/fender/shared/bundle/ruby/2.5.0/gems/unicorn-5.4.1/lib/unicorn/http_server.rb:77:in `initialize'
      #       01   /var/www/app/fender/shared/bundle/ruby/2.5.0/gems/unicorn-5.4.1/bin/unicorn:126:in `new'
      #       01   /var/www/app/fender/shared/bundle/ruby/2.5.0/gems/unicorn-5.4.1/bin/unicorn:126:in `<top (required)>'
      #       01   /var/www/app/fender/shared/bundle/ruby/2.5.0/bin/unicorn:23:in `load'
      #       01   /var/www/app/fender/shared/bundle/ruby/2.5.0/bin/unicorn:23:in `<top (required)>'
      #       01 master failed to start, check stderr log for details
      # #<Thread:0x00007f8501ad46b0@/Users/natsukisugawara/.rbenv/versions/2.5.1/lib/ruby/gems/2.5.0/gems/sshkit-1.17.0/lib/sshkit/runners/parallel.rb:10 run> terminated with exception (report_on_exception is true):
      # Traceback (most recent call last):
      # 	1: from /Users/natsukisugawara/.rbenv/versions/2.5.1/lib/ruby/gems/2.5.0/gems/sshkit-1.17.0/lib/sshkit/runners/parallel.rb:11:in `block (2 levels) in execute'
      # /Users/natsukisugawara/.rbenv/versions/2.5.1/lib/ruby/gems/2.5.0/gems/sshkit-1.17.0/lib/sshkit/runners/parallel.rb:15:in `rescue in block (2 levels) in execute': Exception while executing as nattu@118.27.9.161: bundle exit status: 1 (SSHKit::Runner::ExecuteError)

      # ローカルでfender/shared/tmp/pids/のディレクトリを作ってあげれば治る
      # https://blog.nagatech.work/post/ruby/78

      
